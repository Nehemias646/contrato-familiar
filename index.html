<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contrato Familiar Digital</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- PDF Generation Libraries -->
    <!-- html2canvas es necesario para convertir el HTML en una imagen -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- jspdf es necesario para convertir la imagen en un PDF descargable -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Importar fuentes clásicas -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
    
    <style>
        /* CONFIGURACIÓN GENERAL */
        body {
            font-family: 'Open Sans', sans-serif;
            background-color: #f7f7f7;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
        }

        /* SIMULACIÓN DEL DOCUMENTO DE CONTRATO (Papel Antiguo) */
        .contract-wrapper {
            position: relative;
            width: 100%;
            max-width: 900px;
            aspect-ratio: 16 / 9;
            /* Recreación de la textura del papel */
            background-color: #f7f5e8; /* Color de papel viejo */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            padding: 50px 0; /* Padding vertical para el contenido */
            margin-top: 180px; /* Espacio para el panel de control */
            border: 5px double #a88b5c; /* Borde doble decorativo */
        }

        /* DECORACIONES DE ESQUINA */
        .contract-wrapper::before, .contract-wrapper::after {
            content: '';
            position: absolute;
            width: 30px;
            height: 30px;
            border: 3px solid #a88b5c;
            border-radius: 50%;
            opacity: 0.6;
            z-index: 10;
        }
        .contract-wrapper::before {
            top: 20px;
            left: 20px;
            border-bottom: none;
            border-right: none;
            transform: rotate(-45deg);
        }
        .contract-wrapper::after {
            top: 20px;
            right: 20px;
            border-bottom: none;
            border-left: none;
            transform: rotate(45deg);
        }
        
        /* TÍTULOS Y TEXTO FIJO */
        .contract-title {
            font-family: 'Playfair Display', serif;
            color: #4A4A4A;
            font-size: 2.2rem;
            font-weight: 700;
            text-align: center;
            position: absolute;
            top: 5.5%;
            width: 100%;
            pointer-events: none;
            text-shadow: 0 1px 1px rgba(255, 255, 255, 0.5);
        }
        .contract-subtitle {
            font-family: 'Open Sans', sans-serif;
            color: #6A6A6A;
            font-size: 0.95rem;
            text-align: center;
            position: absolute;
            top: 13%;
            width: 100%;
            pointer-events: none;
        }
        .contract-activity-text {
            font-family: 'Open Sans', sans-serif;
            color: #333;
            font-size: 0.9rem;
            text-align: left;
            position: absolute;
            bottom: 3.5%;
            left: 10.5%;
            width: 77%;
            pointer-events: none;
            line-height: 1.3;
        }

        /* CAPA DE CAMPOS DE FORMULARIO */
        .form-fields-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .input-group {
            display: flex;
            align-items: center;
            position: absolute;
            width: 77%;
            left: 10.5%;
            height: 25px;
        }

        .input-group label {
            width: auto;
            font-size: 0.95rem;
            color: #333;
            font-weight: 600;
            white-space: nowrap;
            margin-right: 10px;
            font-family: 'Open Sans', sans-serif;
        }

        .input-field {
            flex-grow: 1;
            border: none;
            border-bottom: 1px solid #777; /* La línea del contrato */
            background: transparent;
            padding: 2px 5px;
            font-size: 1.05rem;
            color: #000;
            outline: none;
            transition: border-bottom-color 0.2s;
            height: 100%;
            box-sizing: border-box;
        }

        .input-field:focus {
            border-bottom-color: #000;
        }

        /* HORARIO - LÍNEAS PUNTEADAS */
        .horario-field {
            display: flex;
            gap: 10px;
            flex-grow: 1;
            height: 100%;
        }
        .horario-field input {
            height: 100%;
            box-sizing: border-box;
        }
        .horario-field input:nth-child(1) {
            flex-basis: 35%; 
            border-bottom-style: solid;
        }
        .horario-field input:nth-child(2) {
            flex-basis: 65%;
            border-bottom: 1px dashed #777; /* Línea punteada */
            border-radius: 0;
            padding-left: 5px;
        }

        /* FIRMA Y FECHA */
        .signature-row {
            position: absolute;
            bottom: 15%;
            left: 10.5%;
            width: 77%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 25px;
        }
        .signature-row .input-group {
            position: static;
            width: auto;
            left: auto;
            display: flex;
            flex: 1;
            margin: 0;
            height: 100%;
        }
        .signature-row .input-group:first-child {
            margin-right: 18%;
        }
        .signature-row .input-group:last-child {
            max-width: 25%;
        }
        
        /* SELLO DORADO DECORATIVO */
        .stamp-golden {
            position: absolute;
            bottom: 10%;
            right: 10%;
            width: 60px;
            height: 60px;
            background-color: #daa520; /* Color dorado */
            border-radius: 50%;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.8), inset 0 0 10px rgba(255, 255, 255, 0.5);
            pointer-events: none;
        }
        /* ESTADO DE GUARDADO */
        #saveStatus {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 8px;
            color: white;
            z-index: 1000;
            transition: opacity 0.3s ease-in-out;
            opacity: 0;
            pointer-events: none;
        }

        .toast-show {
            opacity: 1 !important;
        }
    </style>
</head>
<body>

    <!-- Panel de Control de la IA (Fijo en la parte superior) -->
    <div id="ai-control-panel" class="fixed top-0 left-0 right-0 bg-gray-800 text-white p-4 shadow-lg z-50 rounded-b-xl">
        <h2 class="text-xl font-bold mb-3 text-yellow-300">Asistente de Contrato Familiar</h2>
        <div class="flex flex-wrap items-center gap-4">
            <input type="text" id="prompt-input" placeholder="Ej: Sugerir tareas para un niño de 8 años." class="p-2 flex-grow rounded-md text-gray-900 border border-gray-600 focus:ring-yellow-500 focus:border-yellow-500 min-w-[300px] md:min-w-0" onkeydown="if(event.key === 'Enter') generateContent()">
            
            <button onclick="generateContent()" class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-semibold py-2 px-4 rounded-md shadow-md transition duration-300">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v3.586L7.707 9.293a1 1 0 00-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 10.586V7z" clip-rule="evenodd" />
                </svg>
                Asistir
            </button>
            
            <!-- BOTÓN PARA DESCARGAR PDF -->
            <button onclick="generatePDF()" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-md shadow-md transition duration-300">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M5.5 5A2.5 2.5 0 018 2.5h4A2.5 2.5 0 0114.5 5v10A2.5 2.5 0 0112 17.5H8A2.5 2.5 0 015.5 15V5zm1.5-1A.5.5 0 006 4.5v10a.5.5 0 00.5.5h7a.5.5 0 00.5-.5V4.5a.5.5 0 00-.5-.5h-7zM10 7a1 1 0 000 2h.01a1 1 0 000-2H10zm0 3a1 1 0 000 2h.01a1 1 0 000-2H10zM10 13a1 1 0 000 2h.01a1 1 0 000-2H10z" clip-rule="evenodd" />
                </svg>
                Descargar PDF
            </button>
        </div>
        
        <div id="ai-output" class="mt-3 p-3 bg-gray-700 rounded-md text-sm min-h-[50px] max-h-[100px] overflow-y-auto">
            El Asistente de IA te ayudará a llenar los campos con ideas o sugerencias.
        </div>
        <div id="loading-indicator" class="hidden mt-2 text-yellow-400 font-semibold">
            Generando contenido... Por favor, espere.
        </div>
    </div>

    <!-- DOCUMENTO DE CONTRATO (Área Principal) -->
    <div class="contract-wrapper">

        <!-- TÍTULOS FIJOS -->
        <p class="contract-title">NUESTRO CONTRATO FAMILIAR</p>
        <p class="contract-subtitle">ESTE CONTRATO ES UN COMPROMISO DE AMOR, RESPETO Y COOPERACIÓN MUTUA</p>

        <!-- CAPA DE CAMPOS (Posicionamiento Absoluto) -->
        <div class="form-fields-overlay">
            
            <!-- Campo 1: Nombre de Miembro -->
            <div class="input-group" style="top: 22%;">
                <label for="member-name">Miembro de la Familia:</label>
                <input type="text" id="member-name" name="member-name" class="input-field" data-db-field="memberName">
            </div>

            <!-- Campo 2: Edad -->
            <div class="input-group" style="top: 26.5%; width: 20%; left: 70%;">
                <label for="age">Edad:</label>
                <input type="number" id="age" name="age" class="input-field" data-db-field="age">
            </div>

            <!-- Campo 3: Mis 3 Tareas/Responsabilidades -->
            <div class="input-group" style="top: 35.5%;">
                <label for="task-1">Mis 3 Tareas/Responsabilidades: 1.</label>
                <input type="text" id="task-1" name="task-1" class="input-field" data-db-field="task1">
            </div>
            <div class="input-group" style="top: 39.5%;">
                <label for="task-2" class="opacity-0">Mis 3 Tareas/Responsabilidades: 2.</label>
                <input type="text" id="task-2" name="task-2" class="input-field" style="margin-left: 172px;" data-db-field="task2">
            </div>
            <div class="input-group" style="top: 43.5%;">
                <label for="task-3" class="opacity-0">Mis 3 Tareas/Responsabilidades: 3.</label>
                <input type="text" id="task-3" name="task-3" class="input-field" style="margin-left: 172px;" data-db-field="task3">
            </div>

            <!-- Campo 4: Horario (Líneas Punteadas) -->
            <div class="input-group" style="top: 52.5%;">
                <label for="schedule-time">Horario:</label>
                <div class="horario-field">
                    <input type="text" id="schedule-time" name="schedule-time" placeholder="Días y horas" data-db-field="scheduleTime">
                    <!-- Campo Punteado -->
                    <input type="text" id="schedule-notes" name="schedule-notes" placeholder="Notas adicionales" data-db-field="scheduleNotes">
                </div>
            </div>

            <!-- Campo 5: El "YO SOY..." (Líneas Punteadas) -->
            <div class="input-group" style="top: 61.5%;">
                <label for="affirmation-1">El “YO SOY…” que me comprometo a ser:</label>
                <input type="text" id="affirmation-1" name="affirmation-1" class="input-field" data-db-field="affirmation1">
            </div>
            <div class="input-group" style="top: 65.5%;">
                <input type="text" id="affirmation-2" name="affirmation-2" class="input-field" style="margin-left: 236px;" data-db-field="affirmation2">
            </div>
            <div class="input-group" style="top: 69.5%;">
                <input type="text" id="affirmation-3" name="affirmation-3" class="input-field" style="margin-left: 236px;" data-db-field="affirmation3">
            </div>

            <!-- Fila de Firma y Fecha -->
            <div class="signature-row">
                <div class="input-group">
                    <label for="signature">Firma:</label>
                    <input type="text" id="signature" name="signature" class="input-field" data-db-field="signature">
                </div>
                <div class="input-group">
                    <label for="date">Fecha:</label>
                    <input type="text" id="date" name="date" class="input-field" data-db-field="date">
                </div>
            </div>

        </div>
        
        <!-- DECORACIONES ADICIONALES -->
        <!-- Sello dorado decorativo -->
        <div class="stamp-golden"></div>
        
        <!-- TEXTO DE ACTIVIDAD FIJO -->
        <p class="contract-activity-text">Actividad: 60 s en parejas para reflexionar sobre lo que más le gusta de la persona que tienen enfrente.</p>
    </div>

    <!-- Toast para estado de guardado -->
    <div id="saveStatus" class="bg-green-500">Guardado Automático</div>

<script type="module">
    // -------------------------------------------------------------------------
    // CONFIGURACIÓN PARA EL ENTORNO DE CANVAS
    // Se utilizan las variables globales inyectadas para la configuración de Firebase
    // -------------------------------------------------------------------------
    
    // Variables globales de Canvas
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    const CONTRACT_DOC_ID = 'main_contract'; // ID fijo para el documento del contrato
    
    // Importar Firebase SDKs
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // setLogLevel('Debug'); // Descomentar para depuración de Firebase

    let db;
    let auth;
    let userId = null;
    let contractDocRef = null;
    let isAuthReady = false;

    // DOM Elements
    const allInputFields = document.querySelectorAll('.input-field');
    const saveStatus = document.getElementById('saveStatus');
    const aiOutput = document.getElementById('ai-output');
    const loadingIndicator = document.getElementById('loading-indicator');

    // Function to show save status toast
    const showSaveStatus = (message, isError = false) => {
        saveStatus.textContent = message;
        saveStatus.className = `fixed bottom-4 right-4 p-3 rounded-lg text-white shadow-lg transition-opacity toast-show ${isError ? 'bg-red-500' : 'bg-green-500'}`;
        setTimeout(() => {
            saveStatus.classList.remove('toast-show');
        }, 3000);
    };

    // 1. Initialize Firebase and Authentication
    const initializeFirebase = async () => {
        if (!firebaseConfig) {
            console.error("Firebase configuration not available.");
            showSaveStatus("Error: Configuración de Firebase no encontrada.", true);
            return;
        }

        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // Autenticación usando el token de Canvas o anónima como fallback
            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                await signInAnonymously(auth);
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // Usar user.uid para la ruta privada de Canvas
                    userId = user.uid;
                    // Ruta: /artifacts/{appId}/users/{userId}/contracts/main_contract
                    contractDocRef = doc(db, 'artifacts', appId, 'users', userId, 'contracts', CONTRACT_DOC_ID);
                    isAuthReady = true;
                    // Iniciar la escucha de datos después de la autenticación
                    listenForContractChanges();
                    console.log("Firestore initialized. User ID:", userId);
                    showSaveStatus("Conectado al almacenamiento de datos.", false);
                } else {
                    console.log("No user signed in or authentication failed.");
                    showSaveStatus("Error de autenticación Firebase.", true);
                }
            });

        } catch (error) {
            console.error("Error initializing Firebase or signing in:", error);
            showSaveStatus("Error al iniciar la aplicación. Revise su configuración Firebase.", true);
        }
    };

    // 2. Load data from Firestore (Real-time listener)
    const listenForContractChanges = () => {
        if (!isAuthReady || !contractDocRef) return;

        onSnapshot(contractDocRef, (doc) => {
            if (doc.exists()) {
                const data = doc.data();
                // Fill the form fields with the loaded data
                allInputFields.forEach(input => {
                    const fieldName = input.getAttribute('data-db-field');
                    if (data[fieldName] !== undefined) {
                        input.value = data[fieldName];
                    }
                });
                console.log("Data loaded from Firestore successfully.");
            } else {
                console.log("No existing contract found. Starting fresh.");
            }
        }, (error) => {
            console.error("Error listening to contract changes:", error);
            showSaveStatus("Error de conexión con la base de datos.", true);
        });
    };

    // 3. Save data to Firestore (Called on every input change)
    const saveContract = async (fieldName, value) => {
        if (!isAuthReady || !contractDocRef) {
            // No mostrar el toast si el error es solo por la inicialización de Firebase
            console.warn("Save attempted before Firebase was ready.");
            return;
        }
        
        const dataToSave = { [fieldName]: value };
        
        try {
            // Use setDoc with { merge: true } to update only the specific field
            await setDoc(contractDocRef, dataToSave, { merge: true });
            showSaveStatus("Guardado automático");
        } catch (error) {
            console.error("Error saving data:", error);
            showSaveStatus("Error al guardar los datos.", true);
        }
    };

    // 4. Setup input change listeners for saving
    const setupInputListeners = () => {
        allInputFields.forEach(input => {
            input.addEventListener('input', (event) => {
                const fieldName = event.target.getAttribute('data-db-field');
                const value = event.target.value;
                if (fieldName) {
                    saveContract(fieldName, value);
                }
            });
        });
    };
    
    // 5. AI Assistant Function (API Call to Gemini)
    window.generateContent = async () => {
        const promptInput = document.getElementById('prompt-input');
        const userPrompt = promptInput.value.trim();

        if (!userPrompt) {
            aiOutput.textContent = "Por favor, introduce una pregunta o solicitud para el asistente.";
            return;
        }

        loadingIndicator.classList.remove('hidden');
        aiOutput.textContent = ''; // Clear previous output

        // Capture current contract data for context
        const contractData = {};
        allInputFields.forEach(input => {
            const fieldName = input.getAttribute('data-db-field');
            contractData[fieldName] = input.value;
        });
        const currentContext = JSON.stringify(contractData, null, 2);

        const systemPrompt = "Eres un asistente familiar amigable y servicial, especializado en la creación de contratos familiares. Tu tarea es responder a la solicitud del usuario (userQuery) basándote en el 'Contexto Actual del Contrato'. Proporciona una respuesta clara, concisa y directamente aplicable al llenado del formulario. No incluyas saludos ni despedidas. Si el usuario te pide sugerencias de tareas, lista 3-5 opciones directas.";
        const userQuery = `Solicitud del usuario: "${userPrompt}". Contexto Actual del Contrato: ${currentContext}.`;

        // INSTRUCCIÓN CRÍTICA: Si se ejecuta fuera de Canvas (ej. GitHub Pages), 
        // DEBE reemplazar el valor "" con su propia CLAVE DE API de Gemini. 
        // En este entorno de Canvas, déjelo como "".
        const apiKey = ""; 
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
        
        let responseText = "Lo siento, hubo un error al conectar con el asistente. (Error de red o API Key).";

        try {
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            // Exponential backoff retry logic
            for (let i = 0; i < 3; i++) {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    const result = await response.json();
                    responseText = result.candidates?.[0]?.content?.parts?.[0]?.text || "No se pudo generar una respuesta útil.";
                    break; 
                } else if (response.status === 429 && i < 2) {
                    const delay = Math.pow(2, i) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                } else {
                    // Manejo de error específico para API Key inválida (400/403)
                    if (response.status === 400 || response.status === 403) {
                         responseText = `Error de API (Código ${response.status}): Parece que su clave de API de Gemini no es válida o está ausente. Si está en GitHub Pages, ingrese su clave personal en el código.`;
                    }
                    throw new Error(`API error: ${response.status}`);
                }
            }

        } catch (error) {
            console.error("Error during API call:", error);
            if (error.message.includes("Failed to fetch")) {
                responseText = "Ocurrió un error de red. Verifique su conexión o que el archivo no esté bloqueado por políticas de CORS.";
            } else if (!responseText.includes("Error de API")) {
                responseText = "Ocurrió un error inesperado al contactar al servidor.";
            }
        } finally {
            loadingIndicator.classList.add('hidden');
            aiOutput.textContent = responseText;
        }
    };
    
    // 6. Function to generate and download the PDF
    window.generatePDF = async () => {
        const input = document.querySelector('.contract-wrapper');
        showSaveStatus("Preparando la descarga en PDF...", false);

        // Hide elements we don't want in the PDF (AI panel, toast)
        const panel = document.getElementById('ai-control-panel');
        const status = document.getElementById('saveStatus');
        panel.style.display = 'none';
        status.style.display = 'none';
        
        // Temporarily adjust margin for clean capture
        const originalMarginTop = input.style.marginTop;
        input.style.marginTop = '20px'; 

        try {
            // html2canvas to render the DOM to a canvas
            const canvas = await html2canvas(input, {
                scale: 3, // Higher scale = better quality
                useCORS: true,
                allowTaint: true,
                logging: false
            });
            
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4'); 
            
            // PDF A4 dimensions in mm
            const pdfWidth = 210; 

            // Calculate image height while maintaining aspect ratio
            const imgWidth = pdfWidth;
            const imgHeight = (canvas.height * imgWidth) / canvas.width;

            const imgData = canvas.toDataURL('image/png');
            
            // Add the image to the PDF
            pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight); 
            
            // Get member name for file naming
            const memberName = document.getElementById('member-name').value || 'Contrato_Familiar';
            const fileName = `${memberName.replace(/\s/g, '_')}_${new Date().toISOString().slice(0, 10)}.pdf`;

            pdf.save(fileName);
            showSaveStatus("PDF generado y descargado exitosamente.", false);

        } catch (error) {
            console.error("Error generating PDF:", error);
            showSaveStatus("Error al generar el PDF. Asegúrese de que el contrato esté visible en pantalla.", true);
        } finally {
            // Restore hidden elements and original style
            panel.style.display = 'block';
            status.style.display = 'block';
            input.style.marginTop = originalMarginTop; 
        }
    };

    // Initialize all on window load
    window.onload = () => {
        initializeFirebase();
        setupInputListeners();
    };
</script>
</body>
</html>
